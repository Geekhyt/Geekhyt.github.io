(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{498:function(t,s,a){"use strict";a.r(s);var n=a(63),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("从源码角度探求Node.js的事件循环本质。")]),t._v(" "),a("blockquote",[a("p",[t._v("本文已收录在"),a("code",[t._v("Github")]),t._v(" "),a("a",{attrs:{href:"https://github.com/Geekhyt/front-end-canteen",target:"_blank",rel:"noopener noreferrer"}},[t._v("github.com/Geekhyt"),a("OutboundLink")],1),t._v("，感谢Star。")])]),t._v(" "),a("h2",{attrs:{id:"事件循环"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事件循环"}},[t._v("#")]),t._v(" 事件循环")]),t._v(" "),a("p",{attrs:{align:"center"}},[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/node0.jpg",width:"500"}})]),t._v(" "),a("p",[t._v("事件循环的执行顺序从图中可以看出，每次的事件循环都包含了上图中的6个阶段，接下来我们来一一解读它们。")]),t._v(" "),a("h3",{attrs:{id:"timers-定时器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#timers-定时器"}},[t._v("#")]),t._v(" timers 定时器")]),t._v(" "),a("p",[t._v("计时器分为两类：")]),t._v(" "),a("ul",[a("li",[t._v("Immediate 在下一个check阶段执行")]),t._v(" "),a("li",[t._v("Timeout 定时器过期后执行(delay参数默认值为1ms)")])]),t._v(" "),a("p",[t._v("Timeout计时器又有两种类型：")]),t._v(" "),a("ul",[a("li",[t._v("Interval")]),t._v(" "),a("li",[t._v("Timeout")])]),t._v(" "),a("p",[a("code",[t._v("这个阶段会执行setTimeout()和setInterval()设定的回调")])]),t._v(" "),a("p",[a("code",[t._v("timers的执行是由poll阶段控制的")])]),t._v(" "),a("p",[t._v("setTimeout()和setInterval()和浏览器中的API是相同的。它们的实现原理与异步I/O比较类似，但是不需要I/O线程池的参与。")]),t._v(" "),a("p",[t._v("这两个定时器创建后会被插入到定时器观察者内部的一个红黑树中。每次Tick执行时，都会从红黑树中取出定时器对象，来检查它们是否超过定时时间，超过便执行它们的回调。")]),t._v(" "),a("p",[t._v("注意：定时器存在一个问题，就是它不是绝对精确的(在容忍范围内)。一旦某个事件循环中，有一个任务占用了较多的时间，那么再次轮到定时器执行时，时间就会受到影响。")]),t._v(" "),a("h4",{attrs:{id:"无io处理情况"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#无io处理情况"}},[t._v("#")]),t._v(" 无IO处理情况")]),t._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("timeout")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'timeout'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setImmediate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("immediate")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'immediate'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("通过执行上面的代码我们可以发现，输出结果是不确定的。")]),t._v(" "),a("p",[t._v("因为setTimeout（fn, 0)具有几毫秒的不确定性，无法保证进入timers阶段，定时器能立即执行处理程序。")]),t._v(" "),a("h4",{attrs:{id:"有io处理情况"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#有io处理情况"}},[t._v("#")]),t._v(" 有IO处理情况")]),t._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fs'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nfs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'timeout'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setImmediate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'immediate'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// immediate")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// timeout")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br")])]),a("p",[t._v("此时setImmediate优先于setTimeout执行，因为poll阶段执行完成后进入check阶段，而timers阶段则处于下一个事件循环阶段了。")]),t._v(" "),a("h3",{attrs:{id:"pending-callbacks-待定回调"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pending-callbacks-待定回调"}},[t._v("#")]),t._v(" pending callbacks 待定回调")]),t._v(" "),a("p",[a("code",[t._v("执行大部分回调，除了close，times和setImmediate()设定的回调")])]),t._v(" "),a("h3",{attrs:{id:"idle，perpare"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#idle，perpare"}},[t._v("#")]),t._v(" idle，perpare")]),t._v(" "),a("p",[a("code",[t._v("仅供内部使用")])]),t._v(" "),a("h3",{attrs:{id:"poll-轮询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#poll-轮询"}},[t._v("#")]),t._v(" poll 轮询")]),t._v(" "),a("p",[a("code",[t._v("获取新的I/O事件，在适当的条件下，Node.js会在这里阻塞")])]),t._v(" "),a("p",[a("code",[t._v("这个阶段的主要任务是执行到达delay时间的timers定时器的回调，并且处理poll队列里的事件。")])]),t._v(" "),a("p",[t._v("当事件循环进入poll阶段，并且没有调用定时器时，将会发生以下两种情况：")]),t._v(" "),a("p",[t._v("1.如果poll队列不为空，事件循环将遍历同步执行它们的回调队列。")]),t._v(" "),a("p",[t._v("2.如果poll队列为空，又分为两种情况：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("如果被setImmediate()回调调用，事件循环会结束poll阶段，进入到check阶段。")])]),t._v(" "),a("li",[a("p",[t._v("如果没有被setImmediate()回调调用，事件循环将阻塞并等待回调添加到poll队列中执行。")])])]),t._v(" "),a("p",[t._v("一旦poll队列为空，事件循环将查看计时器是否到达delay时间，如果一个或多个定时器已达到delay时间，事件循环将回滚到timers定时器阶段，执行它们的回调。")]),t._v(" "),a("h3",{attrs:{id:"check-检测"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#check-检测"}},[t._v("#")]),t._v(" check 检测")]),t._v(" "),a("p",[a("code",[t._v("setImmediate()设定的回调会在这一阶段执行")])]),t._v(" "),a("p",[t._v("如同上文poll阶段的第二种情况中，如果poll队列为空，并且被setImmediate()回调调用，事件循环将直接进入check阶段。")]),t._v(" "),a("h3",{attrs:{id:"close-callbacks-关闭的回调函数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#close-callbacks-关闭的回调函数"}},[t._v("#")]),t._v(" close callbacks 关闭的回调函数")]),t._v(" "),a("p",[a("code",[t._v("socket.on('close',callback)的回调会在这个阶段执行")])]),t._v(" "),a("h2",{attrs:{id:"libuv"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#libuv"}},[t._v("#")]),t._v(" libuv")]),t._v(" "),a("p",[a("code",[t._v("libuv为Node.js提供了整个事件循环功能。")])]),t._v(" "),a("p",{attrs:{align:"center"}},[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/node1.png",width:"500"}})]),t._v(" "),a("p",[t._v("如上图所示，在Windows下，事件循环基于"),a("code",[t._v("IOCP")]),t._v("创建，在linux下通过"),a("code",[t._v("epoll")]),t._v("实现，FreeBSD下通过"),a("code",[t._v("kqueue")]),t._v("实现，在Solaris下通过"),a("code",[t._v("Event ports")]),t._v("实现。")]),t._v(" "),a("p",[t._v("我们再细心的去看上图，Network I/O和file I/O、DNS等实现方式是被分隔开的，这是因为他们的本质是由两套机制来实现的。我们一会儿来通过源码窥探它们的本质。")]),t._v(" "),a("p",[t._v("实质上，当我们写JavaScript代码去调用Node的核心模块时，核心模块会调用C++内建模块，内建模块通过libuv进行系统调用。")]),t._v(" "),a("h3",{attrs:{id:"libuv主要解决的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#libuv主要解决的问题"}},[t._v("#")]),t._v(" libuv主要解决的问题")]),t._v(" "),a("p",[t._v("在现实世界中，在所有不同类型的操作系统平台下，支持不同类型的I/O是非常困难的。那么为了支持跨平台I/O的同时，能更好的管理整个流程，抽象出了libuv。")]),t._v(" "),a("p",[t._v("简单说，就是libuv抽象出一层API，可以帮助你调用各个平台和机器上各种系统特性，包括操作文件、监听socket等，而你不需要了解它们的具体实现。")]),t._v(" "),a("h3",{attrs:{id:"核心源码解读"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心源码解读"}},[t._v("#")]),t._v(" 核心源码解读")]),t._v(" "),a("h4",{attrs:{id:"核心函数uv-run"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心函数uv-run"}},[t._v("#")]),t._v(" 核心函数uv_run")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/libuv/libuv/blob/v1.x/src/unix/core.c",target:"_blank",rel:"noopener noreferrer"}},[t._v("源码"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv_run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("uv_loop_t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" uv_run_mode mode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" ran_pending"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 检查loop中是否有异步任务，没有就结束。")]),t._v("\n    r "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv__loop_alive")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv__update_time")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 事件循环while")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" loop"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("stop_flag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 更新事件阶段")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv__update_time")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  \n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 处理timer回调")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv__run_timers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("        \n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 处理异步任务回调")]),t._v("\n        ran_pending "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv__run_pending")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("      \n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 供内部使用")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv__run_idle")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv__run_prepare")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("        \n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// uv_backend_timeout计算完毕后，会传给uv__io_poll")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果timeout = 0,则uv__io_poll会直接跳过")]),t._v("\n        timeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" UV_RUN_ONCE "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("ran_pending "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" mode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" UV_RUN_DEFAULT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          timeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv_backend_timeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv__io_poll")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// check阶段")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv__run_check")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 关闭文件描述符等操作")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv__run_closing_handles")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 检查loop中是否有异步任务，没有就结束。")]),t._v("\n        r "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv__loop_alive")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" UV_RUN_ONCE "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" mode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" UV_RUN_NOWAIT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br")])]),a("p",[t._v("事件循环的真实面目是一个while。")]),t._v(" "),a("p",[t._v("上文说到Network I/O与file I/O、DNS等是由两套机制来实现的。")]),t._v(" "),a("p",[t._v("首先我们来看Network I/O，它最后的调用都会归结到"),a("code",[t._v("uv__io_start")]),t._v("这个函数，而该函数会将需要执行的I/O事件和回调放入watcher队列中，而"),a("code",[t._v("uv__io_poll")]),t._v("阶段会从watcher队列中取出事件调用系统的接口并执行。")]),t._v(" "),a("p",[t._v("("),a("code",[t._v("uv__io_poll")]),t._v("部分的代码过长大家感兴趣可自行查看)")]),t._v(" "),a("h3",{attrs:{id:"uv-io-start"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#uv-io-start"}},[t._v("#")]),t._v(" uv__io_start")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv__io_start")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("uv_loop_t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" uv__io_t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" w"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" events"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("events "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("POLLIN "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" POLLOUT "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" UV__POLLRDHUP "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" UV__POLLPRI"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" events"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("w"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("fd "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("assert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("w"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("fd "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" INT_MAX"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  w"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("pevents "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|=")]),t._v(" events"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("maybe_resize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" w"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("fd "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("w"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("events "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" w"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("pevents"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("QUEUE_EMPTY")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("w"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("watcher_queue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("QUEUE_INSERT_TAIL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("watcher_queue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("w"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("watcher_queue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("watchers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("w"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("fd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    loop"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("watchers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("w"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("fd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" w"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    loop"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("nfds"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br")])]),a("p",[t._v("如上所示就是我们libuv中Network I/O这条主线实现过程。")]),t._v(" "),a("p",[t._v("而另外一条主线是Fs I/O和DNS等操作则会调用"),a("code",[t._v("uv__work_sumit")]),t._v("这个函数，这个函数是执行线程池初始化"),a("code",[t._v("uv_queue_work")]),t._v("中最终调用的函数。")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv__work_submit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("uv_loop_t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uv__work")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" w"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("enum")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uv__work_kind")]),t._v(" kind"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("work"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uv__work")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" w"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("done"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uv__work")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" w"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv_once")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("once"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" init_once"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  w"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("loop "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  w"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("work "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" work"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  w"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("done "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" done"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("post")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("w"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("wq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" kind"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br")])]),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv_queue_work")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("uv_loop_t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                  uv_work_t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                  uv_work_cb work_cb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                  uv_after_work_cb after_work_cb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("work_cb "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" UV_EINVAL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv__req_init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" UV_WORK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  req"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("loop "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  req"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("work_cb "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" work_cb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  req"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("after_work_cb "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" after_work_cb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uv__work_submit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("req"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("work_req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                  UV__WORK_CPU"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                  uv__queue_work"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                  uv__queue_done"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br")])]),a("h2",{attrs:{id:"node-js中的事件队列"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-js中的事件队列"}},[t._v("#")]),t._v(" Node.js中的事件队列")]),t._v(" "),a("p",[t._v("Node.js中有多个队列，不同类型的事件在各自的队列中排队。在一个阶段结束后，进入下一个阶段之前，事件循环会在这中间处理中间队列。")]),t._v(" "),a("p",[t._v("原生的libuv事件循环中的队列主要又4种类型：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("过期的定时器和间隔队列")])]),t._v(" "),a("li",[a("p",[t._v("IO事件队列")])]),t._v(" "),a("li",[a("p",[t._v("Immediates队列")])]),t._v(" "),a("li",[a("p",[t._v("close handlers队列")])])]),t._v(" "),a("p",[t._v("除此之外，Node.js还有两个中间队列")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("Next Ticks队列")])]),t._v(" "),a("li",[a("p",[t._v("Other Microtasks队列")])])]),t._v(" "),a("h2",{attrs:{id:"node-js与浏览器的event-loop差异"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-js与浏览器的event-loop差异"}},[t._v("#")]),t._v(" Node.js与浏览器的Event Loop差异")]),t._v(" "),a("p",[t._v("我们可以回顾下浏览器中JavaScript事件循环，请移步我的另一篇系列专栏"),a("RouterLink",{attrs:{to:"/2019/07/javascript-evenloop/"}},[t._v("浏览器中JavaScript的事件循环")])],1),t._v(" "),a("p",[t._v("回来后，先说结论：")]),t._v(" "),a("p",[a("strong",[t._v("在浏览器中，microtask的任务队列是每个macrotask执行完之后执行。")])]),t._v(" "),a("p",[a("strong",[t._v("在Node.js中，microtask会在事件循环的各个阶段之间执行，也就是一个阶段执行完毕，就会去执行microtask队列的任务。")])]),t._v(" "),a("p",[t._v("(本文的Macrotask在WHATWG 中叫task。Macrotask为了便于理解，并没有实际的出处。)")]),t._v(" "),a("p",[t._v("相比于浏览器，node多出了"),a("code",[t._v("setImmediate(宏任务)")]),t._v("和"),a("code",[t._v("process.nextTick(微任务)")]),t._v("这两种异步操作。")]),t._v(" "),a("p",[a("code",[t._v("setImmediate")]),t._v("的回调函数被放在"),a("code",[t._v("check")]),t._v("阶段执行。而"),a("code",[t._v("process.nextTick")]),t._v("会被当做一种"),a("code",[t._v("microtask")]),t._v("，每个阶段结束后都会执行所有的"),a("code",[t._v("microtask")]),t._v("，你可以理解为"),a("code",[t._v("process.nextTick")]),t._v("可以"),a("strong",[t._v("插队")]),t._v("，在下个阶段前执行。")]),t._v(" "),a("h4",{attrs:{id:"process-nexttick插队带来的危害"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#process-nexttick插队带来的危害"}},[t._v("#")]),t._v(" process.nextTick插队带来的危害")]),t._v(" "),a("p",[t._v("process.nextTick的回调会导致事件循环无法进入到下一个阶段。I/O处理完成或者定时器过期后仍然无法执行。会让其他的事件处理程序处于饥饿状态，为了防止这个问题，Node.js提供了一个"),a("code",[t._v("process.maxTickDepth")]),t._v("(默认为1000)。")]),t._v(" "),a("h3",{attrs:{id:"node-js中的微任务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-js中的微任务"}},[t._v("#")]),t._v(" Node.js中的微任务")]),t._v(" "),a("ul",[a("li",[t._v("process.nextTick()")]),t._v(" "),a("li",[t._v("Promise.then()")])]),t._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("Promise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'then'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nprocess"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'nextTick'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// nextTick")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// then")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("p",[t._v("我们可以看到nextTick要早于then执行。")]),t._v(" "),a("h2",{attrs:{id:"node-js-v11变更的事件循环"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-js-v11变更的事件循环"}},[t._v("#")]),t._v(" Node.js v11变更的事件循环")]),t._v(" "),a("p",[t._v("从Node.js v11开始，事件循环的原理发生了变化，在同一个阶段中只要执行了macrotask就会立即执行microtask队列，与浏览器表现一致。具体请参考这个"),a("a",{attrs:{href:"https://github.com/nodejs/node/pull/22842#discussion_r218142520",target:"_blank",rel:"noopener noreferrer"}},[t._v("pr"),a("OutboundLink")],1),t._v("。")])])}),[],!1,null,null,null);s.default=e.exports}}]);