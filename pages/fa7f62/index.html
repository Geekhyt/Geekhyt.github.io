<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>教女朋友学前端之深入理解JS引擎 | 童欧巴博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="web前端技术博客,简洁至上,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="code-1xXsjR4O7D">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.5d660632.css" as="style"><link rel="preload" href="/assets/js/app.e6110941.js" as="script"><link rel="preload" href="/assets/js/2.d5df4bac.js" as="script"><link rel="preload" href="/assets/js/3.91f688ac.js" as="script"><link rel="preload" href="/assets/js/44.cd659556.js" as="script"><link rel="prefetch" href="/assets/js/10.3199ebec.js"><link rel="prefetch" href="/assets/js/11.23fcadef.js"><link rel="prefetch" href="/assets/js/12.c0606614.js"><link rel="prefetch" href="/assets/js/13.f31dd943.js"><link rel="prefetch" href="/assets/js/14.b62224fa.js"><link rel="prefetch" href="/assets/js/15.12d722d0.js"><link rel="prefetch" href="/assets/js/16.c18c577a.js"><link rel="prefetch" href="/assets/js/17.33db1aff.js"><link rel="prefetch" href="/assets/js/18.2169539d.js"><link rel="prefetch" href="/assets/js/19.80147783.js"><link rel="prefetch" href="/assets/js/20.750d5116.js"><link rel="prefetch" href="/assets/js/21.fd13e0c4.js"><link rel="prefetch" href="/assets/js/22.c2229ed4.js"><link rel="prefetch" href="/assets/js/23.2dffd82d.js"><link rel="prefetch" href="/assets/js/24.ed95c331.js"><link rel="prefetch" href="/assets/js/25.273f6808.js"><link rel="prefetch" href="/assets/js/26.f81c2466.js"><link rel="prefetch" href="/assets/js/27.ed1fa402.js"><link rel="prefetch" href="/assets/js/28.86bddcec.js"><link rel="prefetch" href="/assets/js/29.acb6ba1d.js"><link rel="prefetch" href="/assets/js/30.085db3bb.js"><link rel="prefetch" href="/assets/js/31.10a4a0ad.js"><link rel="prefetch" href="/assets/js/32.dab0f919.js"><link rel="prefetch" href="/assets/js/33.ff4e525c.js"><link rel="prefetch" href="/assets/js/34.4972fdf0.js"><link rel="prefetch" href="/assets/js/35.8eef4f2e.js"><link rel="prefetch" href="/assets/js/36.12e3a40e.js"><link rel="prefetch" href="/assets/js/37.1d8cac74.js"><link rel="prefetch" href="/assets/js/38.1b9d84f3.js"><link rel="prefetch" href="/assets/js/39.8da043e8.js"><link rel="prefetch" href="/assets/js/4.f0bed083.js"><link rel="prefetch" href="/assets/js/40.cad56f3f.js"><link rel="prefetch" href="/assets/js/41.078ff48e.js"><link rel="prefetch" href="/assets/js/42.ccab846c.js"><link rel="prefetch" href="/assets/js/43.505c53c7.js"><link rel="prefetch" href="/assets/js/45.14dd0e87.js"><link rel="prefetch" href="/assets/js/46.1839d303.js"><link rel="prefetch" href="/assets/js/47.b210acd4.js"><link rel="prefetch" href="/assets/js/48.5748de13.js"><link rel="prefetch" href="/assets/js/49.0855ea96.js"><link rel="prefetch" href="/assets/js/5.3325315f.js"><link rel="prefetch" href="/assets/js/50.ec32b7d5.js"><link rel="prefetch" href="/assets/js/51.2bbf040f.js"><link rel="prefetch" href="/assets/js/52.3305d4e2.js"><link rel="prefetch" href="/assets/js/53.5ddbb2ed.js"><link rel="prefetch" href="/assets/js/54.66fb0ed1.js"><link rel="prefetch" href="/assets/js/55.502aea49.js"><link rel="prefetch" href="/assets/js/56.b8d4f0b6.js"><link rel="prefetch" href="/assets/js/57.631c9b6f.js"><link rel="prefetch" href="/assets/js/58.de68c1bb.js"><link rel="prefetch" href="/assets/js/59.a8e3322d.js"><link rel="prefetch" href="/assets/js/6.e60bc4f1.js"><link rel="prefetch" href="/assets/js/60.405df580.js"><link rel="prefetch" href="/assets/js/61.b8c9ede6.js"><link rel="prefetch" href="/assets/js/62.ad006f4a.js"><link rel="prefetch" href="/assets/js/63.3a8cad4b.js"><link rel="prefetch" href="/assets/js/64.7f3316c4.js"><link rel="prefetch" href="/assets/js/65.baee1c39.js"><link rel="prefetch" href="/assets/js/66.726c4408.js"><link rel="prefetch" href="/assets/js/67.03b35a22.js"><link rel="prefetch" href="/assets/js/7.a139d7a8.js"><link rel="prefetch" href="/assets/js/8.bb4f29c6.js"><link rel="prefetch" href="/assets/js/9.7d18e657.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5d660632.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/avatar.jpeg" alt="童欧巴博客" class="logo"> <span class="site-name can-hide">童欧巴博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friends/" class="nav-link">友情链接</a></div> <a href="https://github.com/Geekhyt" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="http://hungryturbo.gitee.io/webcanteen/images/avatar.jpeg"> <div class="blogger-info"><h3>童欧巴</h3> <span>公众号【前端食堂】主理人</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friends/" class="nav-link">友情链接</a></div> <a href="https://github.com/Geekhyt" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/pages/ae3fa6/" class="sidebar-link">图解浏览器</a></li><li><a href="/pages/fa7f62/" aria-current="page" class="active sidebar-link">教女朋友学前端之深入理解JS引擎</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/fa7f62/#宏观视角看-v8" class="sidebar-link">宏观视角看 V8</a></li><li class="sidebar-sub-header"><a href="/pages/fa7f62/#星球最强-javascript-引擎" class="sidebar-link">星球最强 JavaScript 引擎</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/fa7f62/#programming-languages-software-award" class="sidebar-link">Programming Languages Software Award</a></li><li class="sidebar-sub-header"><a href="/pages/fa7f62/#主流-js-引擎" class="sidebar-link">主流 JS 引擎</a></li><li class="sidebar-sub-header"><a href="/pages/fa7f62/#v8-发布周期" class="sidebar-link">V8 发布周期</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/fa7f62/#v8-架构演进史" class="sidebar-link">V8 架构演进史</a></li><li class="sidebar-sub-header"><a href="/pages/fa7f62/#v8-工作机制" class="sidebar-link">V8 工作机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/fa7f62/#机器语言、汇编语言、高级语言" class="sidebar-link">机器语言、汇编语言、高级语言</a></li><li class="sidebar-sub-header"><a href="/pages/fa7f62/#解释执行、编译执行" class="sidebar-link">解释执行、编译执行</a></li><li class="sidebar-sub-header"><a href="/pages/fa7f62/#jit-just-in-time" class="sidebar-link">JIT (Just In Time)</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/fa7f62/#v8-核心模块工作原理" class="sidebar-link">V8 核心模块工作原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/fa7f62/#解析器-parser" class="sidebar-link">解析器 Parser</a></li><li class="sidebar-sub-header"><a href="/pages/fa7f62/#解释器-ignition" class="sidebar-link">解释器 Ignition</a></li><li class="sidebar-sub-header"><a href="/pages/fa7f62/#编译器-turbofan" class="sidebar-link">编译器 TurboFan</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/fa7f62/#小结" class="sidebar-link">小结</a></li><li class="sidebar-sub-header"><a href="/pages/fa7f62/#站在巨人的肩膀上" class="sidebar-link">站在巨人的肩膀上</a></li></ul></li></ul> </aside> <div><main class="page"> <div class="theme-vdoing-wrapper bg-style-1"><div class="articleInfo-wrap" data-v-f5f35434><div class="articleInfo" data-v-f5f35434><ul class="breadcrumbs" data-v-f5f35434><li data-v-f5f35434><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-f5f35434></a></li> <li data-v-f5f35434><a href="/categories/?category=%E5%9B%BE%E8%A7%A3%E6%B5%8F%E8%A7%88%E5%99%A8" title="分类" data-v-f5f35434>图解浏览器</a></li> <!----></ul> <div class="info" data-v-f5f35434><div title="作者" class="author iconfont icon-touxiang" data-v-f5f35434><a href="https://github.com/Geekhyt" target="_blank" title="作者" class="beLink" data-v-f5f35434>童欧巴</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-f5f35434><a href="javascript:;" data-v-f5f35434>2021-08-16</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><!---->
          教女朋友学前端之深入理解JS引擎
        </h1> <div class="theme-vdoing-content content__default"><p><strong>食堂老板娘：老板，Chrome V8 引擎工作原理面试会问吗？</strong></p> <p>食堂老板：这块的知识不仅面试可能会问，学会了 JS 引擎的工作原理，可以更好的理解 JavaScript、更好的理解前端生态中 Babel 的词法分析和语法分析，ESLint 的语法检查原理以及 React、Vue 等前端框架的实现原理。总之，学习引擎原理可谓是一举多得。</p> <p><strong>食堂老板娘：好好好，别罗嗦了，快开始吧～</strong></p> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/v801.png" width="500"></p> <h2 id="宏观视角看-v8"><a href="#宏观视角看-v8" class="header-anchor">#</a> 宏观视角看 V8</h2> <p>V8 是我们前端届的网红，它用 C++ 编写，是谷歌开源的高性能 JavaScript 和 WebAssembly 引擎，主要用在 Chrome、Node.js、Electron...中。</p> <p>在开始讲我们的主角 V8 引擎之前，先来从宏观视角展开谈谈 V8 所处的位置，建立一个世界观。</p> <p>在信息科技高速发展的今天，这个疯狂的大世界充斥着各种电子设备，我们每天都用的手机、电脑、电子手表、智能音箱以及现在马路上跑的越来越多的电动汽车。</p> <p>作为软件工程师，我们可以将它们统一理解为“电脑”，它们都是由<code>中央处理器(CPU)、存储以及输入、输出设备构成</code>。CPU 就像厨师，负责按照菜谱执行命令烧菜。存储如同冰箱，负责保存数据以及要执行的命令(食材)。</p> <p>当电脑接通电源，CPU 便开始从存储的某个位置读取指令，按照指令一条一条的执行命令，开始工作。电脑还可以接入各种外部设备，比如：鼠标、键盘、屏幕、发动机等等。CPU 不需要全部搞清楚这些设备的能力，它只负责和这些设备的端口进行数据交换就好。设备厂商也会在提供设备时，附带与硬件匹配的软件，来配合 CPU 一起工作。说到这里，我们便得到了最基础的计算机，也是计算机之父冯·诺伊曼在 1945 年提出的体系结构。</p> <p>不过由于机器指令人类读起来非常不友好，难以阅读和记忆，所以人们发明了编程语言和编译器。编译器可以把人类更容易理解的语言转换为机器指令。除此之外，我们还需要操作系统，来帮我们解决软件治理的问题。我们知道操作系统有很多，如 Windows、Mac、Linux、Android、iOS、鸿蒙等，使用这些操作系统的设备更是数不胜数。为了消除客户端的多样性，实现跨平台并提供统一的编程接口，浏览器便诞生了。</p> <p>所以，我们可以将浏览器看作操作系统之上的操作系统，而对于我们前端工程师最熟悉的 JavaScript 代码来说，浏览器引擎(如：V8)就是它的整个世界。</p> <h2 id="星球最强-javascript-引擎"><a href="#星球最强-javascript-引擎" class="header-anchor">#</a> 星球最强 JavaScript 引擎</h2> <p>毫无疑问，V8 是最流行、最强的 JavaScript 引擎，V8 这个名字的灵感来源于 50 年代经典的“肌肉车”的引擎。</p> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/v802.png" width="500"></p> <h3 id="programming-languages-software-award"><a href="#programming-languages-software-award" class="header-anchor">#</a> Programming Languages Software Award</h3> <p>V8 也曾获得了学术界的肯定，拿到了 ACM SIGPLAN 的 <a href="http://www.sigplan.org/Awards/Software/" target="_blank" rel="noopener noreferrer">Programming Languages Software Award<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="主流-js-引擎"><a href="#主流-js-引擎" class="header-anchor">#</a> 主流 JS 引擎</h3> <p>JavaScript 的主流引擎如下所示：</p> <ul><li><a href="https://v8.dev/" target="_blank" rel="noopener noreferrer">V8 (Google) <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://spidermonkey.dev/" target="_blank" rel="noopener noreferrer">SpiderMonkey (Mozilla) <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developer.apple.com/documentation/javascriptcore/" target="_blank" rel="noopener noreferrer">JavaScriptCore (Apple) <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/microsoft/ChakraCore/" target="_blank" rel="noopener noreferrer">Chakra (Microsoft) <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/svaarala/duktape/" target="_blank" rel="noopener noreferrer">duktape(IOT)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/jerryscript-project/jerryscript/" target="_blank" rel="noopener noreferrer">JerryScript(IOT)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/bellard/quickjs/" target="_blank" rel="noopener noreferrer">QuickJS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/facebook/hermes/" target="_blank" rel="noopener noreferrer">Hermes(Facebook-React Native)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="v8-发布周期"><a href="#v8-发布周期" class="header-anchor">#</a> V8 发布周期</h3> <p>V8 团队使用 4 种 Chrome 发布渠道向用户推送新版本。</p> <ul><li>Canary releases 金丝雀版 (每天)</li> <li>Dev releases 开发版 (每周)</li> <li>Beta releases 测试版 (每 6 周)</li> <li>Stable releases 稳定版 (每 6 周)</li></ul> <p>想要了解更多，请戳 <a href="https://zhuanlan.zhihu.com/p/35038142" target="_blank" rel="noopener noreferrer">V8 引擎版本发布流程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="v8-架构演进史"><a href="#v8-架构演进史" class="header-anchor">#</a> V8 架构演进史</h2> <p>2008 年 9 月 2 日，V8 与 Chrome 在同一天开源，最初的代码提交日期可追溯到 2008 年 6 月 30 日，你可以通过下面的链接查看 V8 代码库的可视化演化进程。</p> <ul><li><a href="https://www.youtube.com/watch?v=G0vnrPTuxZA" target="_blank" rel="noopener noreferrer">使用 gource 创建的 V8 代码库可视化演化进程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/v803.png" width="500"></p> <p>当时的 V8 架构简单粗暴，只有一个 <code>Codegen</code> 编译器。</p> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/v804.png" width="500"></p> <p>2010 年，V8 中加入了 <code>Crankshaft</code> 优化编译器，大大提升了运行时性能。Crankshaft 生成的机器代码比之前的 Codegen 编译器快两倍，而体积减少了 30％。</p> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/v805.png" width="500"></p> <p>2015 年，为了进一步提升性能，V8 引入了 <code>TurboFan</code> 优化编译器。</p> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/v806.png" width="500"></p> <p>接下来到了分水岭，在此之前，V8 都是选择将源码直接编译为机器码的架构。不过随着 Chrome 在移动设备的普及，V8 团队发现了这种架构下存在的致命问题：编译时间过长、机器码的内存占用很大。</p> <p>所以，V8 团队对引擎架构进行了重构，在 2016 年引入了 <code>Ignition 解释器和字节码</code>。</p> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/v807.png" width="500"></p> <p>2017 年，V8 默认开启全新的编译 <code>pipeline(Ignition + TurboFan)</code>，并移除了 <code>Full-codegen 和 Crankshaft</code>。</p> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/v808.png" width="500"></p> <p>高性能的 JS 引擎不仅需要 TurboFan 这样高度优化的编译器，在编译器有机会开始工作之前的性能，也存在着大量的优化空间。</p> <p>于是在 2021 年，V8 引入新的编译管道 <code>Sparkplug</code>。</p> <p>对于 Sparkplug 想要了解更多，请戳<a href="https://v8.dev/blog/sparkplug" target="_blank" rel="noopener noreferrer">Sparkplug<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/v809.png" width="500"></p> <ul><li>关于 V8 架构演进史，想要了解更多请戳<a href="https://v8.dev/blog/10-years" target="_blank" rel="noopener noreferrer">庆祝 V8 诞生 10 周年<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p><strong>食堂老板娘：原来 V8 架构经历了这么多的变化</strong></p> <p>食堂老板：是的，V8 团队为了不断的优化引擎的性能，做了很多努力。</p> <h2 id="v8-工作机制"><a href="#v8-工作机制" class="header-anchor">#</a> V8 工作机制</h2> <p><code>敲黑板，进入本文的重点。</code></p> <p><strong>食堂老板娘：拿出小本本记好</strong></p> <p>V8 执行 JavaScript 代码的核心流程分为以下两个阶段：</p> <ul><li>编译</li> <li>执行</li></ul> <p><code>编译阶段指 V8 将 JavaScript 转换为字节码或者二进制机器码，执行阶段指解释器解释执行字节码，或者 CPU 直接执行二进制机器码。</code></p> <p>为了对 V8 整体的工作机制有更好的理解，我们先来搞懂下面几个概念。</p> <h3 id="机器语言、汇编语言、高级语言"><a href="#机器语言、汇编语言、高级语言" class="header-anchor">#</a> 机器语言、汇编语言、高级语言</h3> <p>CPU 的指令集就是机器语言，CPU 只能识别二进制的指令。但是对人类来说，二进制难以阅读和记忆，所以人们将二进制转换为可以识别、记忆的语言，也就是汇编语言，通过汇编编译器可以将汇编指令转换为机器指令。</p> <p>不同的 CPU 有不同的指令集，使用汇编语言编程需要兼容不同的 CPU 架构，如 ARM、MIPS 等，学习成本比较高。汇编语言这层抽象还远远不够，所以高级语言应运而生，高级语言屏蔽了计算机架构的细节，兼容多种不同的 CPU 架构。</p> <p>CPU 同样不认识高级语言，一般有两种方式执行高级语言的代码，也就是：</p> <ul><li>解释执行</li> <li>编译执行</li></ul> <h3 id="解释执行、编译执行"><a href="#解释执行、编译执行" class="header-anchor">#</a> 解释执行、编译执行</h3> <p>解释执行会先将输入的源码通过解析器编译成中间代码，再直接使用解释器解释执行中间代码，输出结果。</p> <p>编译执行也会将源码转换为中间代码，然后编译器会将中间代码编译成机器码，通常编译成的机器码以二进制文件形式存储，执行二进制文件输出结果。编译后的机器码还可以保存在内存中，可以直接执行内存中的二进制代码。</p> <h3 id="jit-just-in-time"><a href="#jit-just-in-time" class="header-anchor">#</a> JIT (Just In Time)</h3> <p><code>解释执行启动速度快，执行速度慢，而编译执行启动速度慢，执行速度快。</code></p> <p>V8 权衡利弊后同时采用了解释执行和编译执行这两种方式，这种混合使用的方式称为 <code>JIT (即时编译)</code>。</p> <p>V8 在执行 JavaScript 源码时，首先解析器会将源码解析为 AST 抽象语法树，解释器 (Ignition) 会将 AST 转换为字节码，一边解释一边执行。</p> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/v810.png" width="500"></p> <p>解释器同时会记录某一代码片段的执行次数，如果执行次数超过了某个阈值，这段代码便会被标记为热代码(Hot Code)，同时将运行信息反馈给优化编译器 TurboFan，TurboFan 根据反馈信息，会优化并编译字节码，最后生成优化的机器码。</p> <p><strong>食堂老板娘：也就是说，当这段代码再次执行时，解释器就可以直接运行优化后的机器码，不需要再次解释，这样会提升很多性能吧？</strong></p> <p>食堂老板：对的！</p> <p>V8 的解释器和编译器的名字寓意非常有趣，解释器 Ignition 代表点火器，编译器 TurboFan 代表涡轮增压，代码启动时通过点火器发动，TurboFan 一旦介入，执行效率会越来越高。</p> <p>了解了 V8 的大体工作机制，接下来我们继续深入，看一下 V8 核心模块的工作原理。</p> <h2 id="v8-核心模块工作原理"><a href="#v8-核心模块工作原理" class="header-anchor">#</a> V8 核心模块工作原理</h2> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/v808.png" width="500"></p> <p>V8 的核心模块包括：</p> <ul><li><a href="https://v8.dev/blog/scanner/" target="_blank" rel="noopener noreferrer">Parser<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：解析器负责将 JavaScript 代码转换成 AST 抽象语法树。</li> <li><a href="https://v8.dev/docs/ignition/" target="_blank" rel="noopener noreferrer">Ignition<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：解释器负责将 AST 转换为字节码，并收集 TurboFan 需要的优化编译信息。</li> <li><a href="https://v8.dev/docs/turbofan" target="_blank" rel="noopener noreferrer">TurboFan<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：利用解释器收集到的信息，将字节码转换为优化的机器码。</li></ul> <p>V8 需要等编译完成后才可以运行代码，所以解析和编译过程中的性能十分重要。</p> <h3 id="解析器-parser"><a href="#解析器-parser" class="header-anchor">#</a> 解析器 Parser</h3> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/v811.png" width="500"></p> <p>解析器的解析过程分为两个阶段：</p> <ul><li>词法分析 (Scanner 词法分析器)</li> <li>语法分析 (Pre-Parser、Parser 语法分析器)</li></ul> <h4 id="词法分析"><a href="#词法分析" class="header-anchor">#</a> 词法分析</h4> <p><code>Scanner</code> 负责接收 <code>Unicode Stream</code> 字符流，将其解析为 <code>tokens</code>，提供给解析器 <code>Parser</code>。</p> <p>比如下面这段代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> myName <span class="token operator">=</span> <span class="token string">'童欧巴'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被解析成 <code>let</code>，<code>myName</code>，<code>=</code>，<code>'童欧巴'</code>，它们分别是关键字、标识符、赋值运算符以及字符串。</p> <h4 id="语法分析"><a href="#语法分析" class="header-anchor">#</a> 语法分析</h4> <p>接下来，语法分析会将上一步生成的 tokens，根据语法规则转换为 AST，如果源码存在语法错误，在这一阶段就会终止并抛出语法错误。</p> <p>可以通过这个网站查看 AST 的结构：<a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">https://astexplorer.net/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>也可以通过这个链接<a href="https://resources.jointjs.com/demos/javascript-ast" target="_blank" rel="noopener noreferrer">https://resources.jointjs.com/demos/javascript-ast<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>直接生成图片，如下所示：</p> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/v812.png" width="500"></p> <p>得到了 AST，V8 便会生成该段代码的<code>执行上下文</code>。</p> <h4 id="惰性解析"><a href="#惰性解析" class="header-anchor">#</a> 惰性解析</h4> <p>主流的 JavaScript 引擎都采用了<code>惰性解析(Lazy Parsing)</code>，因为源码在执行前如果全部完全解析的话，不仅会造成执行时间过长，而且会消耗更多的内存以及磁盘空间。</p> <p>惰性解析就是指如果遇到并不是立即执行的函数，只会对其进行<code>预解析(Pre-Parser)</code>，当函数被调用时，才会对其完全解析。</p> <p>预解析时，只会验证函数的语法是否有效、解析函数声明以及确定函数作用域，并不会生成 AST，这项工作由 <code>Pre-Parser</code> 预解析器完成。</p> <h3 id="解释器-ignition"><a href="#解释器-ignition" class="header-anchor">#</a> 解释器 Ignition</h3> <p>得到了 AST 和执行上下文，接下来解释器会将 AST 转换为字节码并执行。</p> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/v813.png" width="500"></p> <p><strong>食堂老板娘：为什么要引入字节码呢？</strong></p> <p>引入字节码是一种工程上的权衡，从图中可以看出，仅仅是一个几 KB 的文件，生成的机器码就已经占用了大量的内存空间。</p> <p>相比机器码，<code>字节码不仅占用内存少，而且生成字节码的时间很快，提升了启动速度</code>。虽然字节码没有机器码执行速度快，但是牺牲了一点执行效率，换来的收益还是很值得的。</p> <p>况且，字节码与特定类型的机器码无关，通过解释器将字节码转换为机器码后才可以执行，这样也使得 V8 更加方便的移植到不同的 CPU 架构。</p> <p>你可以通过如下命令，查看 JavaScript 代码生成的字节码。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>node --print-bytecode index.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也可以通过如下链接进行查看：</p> <ul><li><a href="https://github.com/v8/v8/blob/master/src/interpreter/bytecodes.h/" target="_blank" rel="noopener noreferrer">V8 解释器的头文件，包括所有字节码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>我们来看一段代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token punctuation">}</span>

<span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上面的代码在执行命令后，会生成如下的字节码：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>generated bytecode <span class="token keyword">for</span> function: <span class="token function">add</span> <span class="token punctuation">(</span>0x1d3fb97c7da1 <span class="token operator">&lt;</span>SharedFunctionInfo add<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
Parameter count <span class="token number">3</span>
Register count <span class="token number">0</span>
Frame size <span class="token number">0</span>
   <span class="token number">25</span> S<span class="token operator">&gt;</span> 0x1d3fb97c8686 @    <span class="token number">0</span> <span class="token builtin class-name">:</span> <span class="token number">25</span> 02             Ldar a1
   <span class="token number">34</span> E<span class="token operator">&gt;</span> 0x1d3fb97c8688 @    <span class="token number">2</span> <span class="token builtin class-name">:</span> <span class="token number">34</span> 03 00          Add a0, <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
   <span class="token number">37</span> S<span class="token operator">&gt;</span> 0x1d3fb97c868b @    <span class="token number">5</span> <span class="token builtin class-name">:</span> aa                Return
Constant pool <span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
Handler Table <span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
Source Position Table <span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span>
0x1d3fb97c8691 <span class="token operator">&lt;</span>ByteArray<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>其中，Parameter count 3 表示三个参数，包括传入的 a，b 以及 this。字节码的详细信息如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Ldar a1 <span class="token comment">// 表示将寄存器中的值加载到累加器中</span>
Add a0<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// 从 a0 寄存器加载值并且将其与累加器中的值相加，然后将结果再次放入累加器</span>
Return <span class="token comment">// 结束当前函数的执行，并把控制权传给调用方，将累加器中的值作为返回值</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>每行字节码都对应着特定的功能，一行行字节码就如同搭乐高积木一样，组装到一起就构成了完整的程序。</p> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/v814.png" width="500"></p> <p>解释器通常有两种类型，<code>基于栈</code>和<code>基于寄存器的解释器</code>，早期的 V8 解释器也是基于栈的，现在的 V8 解释器采用了基于寄存器的设计，支持寄存器的指令操作，使用寄存器来保存参数和中间计算结果。</p> <p>Ignition 解释器在执行字节码时，主要使用了<code>通用寄存器</code>和<code>累加寄存器</code>，相关的函数参数和局部变量会保存在通用寄存器中，累加寄存器会保存中间结果。</p> <p>在执行指令的过程中，CPU 需要对数据进行读写，如果直接在内存中读写的话，会严重影响程序的执行性能。所以 CPU 就引入了寄存器，将一些中间数据存放到寄存器中，提升 CPU 的执行速度。</p> <h3 id="编译器-turbofan"><a href="#编译器-turbofan" class="header-anchor">#</a> 编译器 TurboFan</h3> <p>在编译方面，V8 团队同样做了很多优化，我们来看下内联和逃逸分析。</p> <h4 id="内联-inlining"><a href="#内联-inlining" class="header-anchor">#</a> 内联 inlining</h4> <p>关于内联，我们先来看一段代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>如上代码所示，我们在 foo 函数中调用了函数 add，add 函数接收 a，b 两个参数，返回他们的和。如果不经过编译器优化，则会分别生成这两个函数所对应的机器码。</p> <p>为了提升性能，TurboFan 优化编译器会将上面两个函数进行内联，然后再进行编译。内联后的函数如下所示：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fooAddInlined</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span>
  <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">4</span>
  <span class="token keyword">var</span> addReturnValue <span class="token operator">=</span> a <span class="token operator">+</span> b
  <span class="token keyword">return</span> addReturnValue
<span class="token punctuation">}</span>

<span class="token comment">// 因为 fooAddInlined 中 a 和 b 的值都是确定的，所以可以进一步优化</span>
<span class="token keyword">function</span> <span class="token function">fooAddInlined</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">6</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>内联优化后，编译生成的机器码会精简很多，执行效率也有很大的提升。</p> <h4 id="逃逸分析-escape-analysis"><a href="#逃逸分析-escape-analysis" class="header-anchor">#</a> 逃逸分析 Escape Analysis</h4> <p>逃逸分析也不难理解，它的意思就是<code>分析对象的生命周期是否仅限于当前函数</code>，我们来看一段代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> a<span class="token punctuation">,</span> y<span class="token operator">:</span> b <span class="token punctuation">}</span>
  <span class="token keyword">return</span> obj<span class="token punctuation">.</span>x <span class="token operator">+</span> obj<span class="token punctuation">.</span>y
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>如果对象只在函数内部定义，并且对象只作用于函数内部的话，就会被认为是“未逃逸”的</code>，我们可以将上面代码进行优化：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> obj_x <span class="token operator">=</span> a
  <span class="token keyword">const</span> obj_y <span class="token operator">=</span> b
  <span class="token keyword">return</span> obj_x <span class="token operator">+</span> obj_y
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>优化后，无需再有对象定义，而且我们可以直接将变量加载到寄存器上，不再需要从内存中访问对象属性。不仅减少了内存消耗，而且提升了执行效率。</p> <p>关于逃逸分析，Chrome 曾经也爆出过安全漏洞，使整个互联网变慢，感兴趣请戳<a href="https://segmentfault.com/a/1190000011413430" target="_blank" rel="noopener noreferrer">V8 团队的一个错误，使得整个互联网变慢<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>除了上述提到的各种优化方案和模块，V8 还有很多优化手段和核心模块，如：使用隐藏类快速获取对象属性、使用内联缓存提升函数执行效率、<a href="https://v8.dev/blog/trash-talk/" target="_blank" rel="noopener noreferrer">Orinoco<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 垃圾回收器、<a href="https://v8.dev/blog/liftoff/" target="_blank" rel="noopener noreferrer">Liftoff<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> WebAssembly 编译器等等，本文不再过多介绍，大家感兴趣可以自行学习。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>本文从宏观视角看 V8、V8 架构演进史、V8 的工作机制以及 V8 核心模块的工作原理几个方面进行了介绍和总结，我们可以发现，无论是 Chrome 还是 Node.js，它们只是一个桥梁，负责把我们前端工程师编写的 JavaScript 代码运输到最终的目的地，转换成对应机器的机器码并执行。在这段旅程中，V8 团队做了很大的努力，给他们最大的 respect。</p> <p>虽然 CPU 的指令集是有限的，但是我们软件工程师编写的程序不是固定的，正是这些程序最终被 CPU 执行，才有了改变世界的可能。</p> <p>你们是最棒的，改变世界的程序们！</p> <p><strong>食堂老板娘：童童，你是最胖的！^_^</strong></p> <h2 id="站在巨人的肩膀上"><a href="#站在巨人的肩膀上" class="header-anchor">#</a> 站在巨人的肩膀上</h2> <ul><li>V8是如何执行 JavaScript 代码的？</li> <li>图解 Google V8</li> <li>许式伟的架构课</li> <li>https://v8.dev/blog</li></ul></div></div> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=%E5%9B%BE%E8%A7%A3%E6%B5%8F%E8%A7%88%E5%99%A8" title="标签">#图解浏览器</a></div> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/ae3fa6/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">图解浏览器</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/ae3fa6/" class="prev">图解浏览器</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/aa01e0/"><div>如何打造高效好用的终端？拿来吧你！</div></a> <span>07-14</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/c0e0d4/"><div>假如易立竞问你如何判断 JavaScript 中的数据类型？</div></a> <span>06-08</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/06210d/"><div>VueConf China 2021 《Vue3生态进展-尤雨溪》 Reaction</div></a> <span>05-23</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div> </main></div> <div class="footer"><div class="icons"><a href="mailto:hungryturbo@gmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/Geekhyt" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://juejin.im/user/3491704662669469" title="掘金" target="_blank" class="iconfont icon-juejin"></a><a href="https://www.zhihu.com/people/huo-yi-tong-98" title="知乎" target="_blank" class="iconfont icon-zhihu"></a><a href="https://weibo.com/u/2771284557" title="微博" target="_blank" class="iconfont icon-weibo"></a><a href="https://space.bilibili.com/161753278" title="哔哩哔哩" target="_blank" class="iconfont icon-bilibili"></a></div> 
        © 2019-2021
        <span>童欧巴 | hungryturbo</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e6110941.js" defer></script><script src="/assets/js/2.d5df4bac.js" defer></script><script src="/assets/js/3.91f688ac.js" defer></script><script src="/assets/js/44.cd659556.js" defer></script>
  </body>
</html>