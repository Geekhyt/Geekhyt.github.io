<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node.js事件循环 | 童欧巴博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="web前端技术博客,简洁至上,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="code-1xXsjR4O7D">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.5d660632.css" as="style"><link rel="preload" href="/assets/js/app.e6110941.js" as="script"><link rel="preload" href="/assets/js/2.d5df4bac.js" as="script"><link rel="preload" href="/assets/js/3.91f688ac.js" as="script"><link rel="preload" href="/assets/js/30.085db3bb.js" as="script"><link rel="prefetch" href="/assets/js/10.3199ebec.js"><link rel="prefetch" href="/assets/js/11.23fcadef.js"><link rel="prefetch" href="/assets/js/12.c0606614.js"><link rel="prefetch" href="/assets/js/13.f31dd943.js"><link rel="prefetch" href="/assets/js/14.b62224fa.js"><link rel="prefetch" href="/assets/js/15.12d722d0.js"><link rel="prefetch" href="/assets/js/16.c18c577a.js"><link rel="prefetch" href="/assets/js/17.33db1aff.js"><link rel="prefetch" href="/assets/js/18.2169539d.js"><link rel="prefetch" href="/assets/js/19.80147783.js"><link rel="prefetch" href="/assets/js/20.750d5116.js"><link rel="prefetch" href="/assets/js/21.fd13e0c4.js"><link rel="prefetch" href="/assets/js/22.c2229ed4.js"><link rel="prefetch" href="/assets/js/23.2dffd82d.js"><link rel="prefetch" href="/assets/js/24.ed95c331.js"><link rel="prefetch" href="/assets/js/25.273f6808.js"><link rel="prefetch" href="/assets/js/26.f81c2466.js"><link rel="prefetch" href="/assets/js/27.ed1fa402.js"><link rel="prefetch" href="/assets/js/28.86bddcec.js"><link rel="prefetch" href="/assets/js/29.acb6ba1d.js"><link rel="prefetch" href="/assets/js/31.10a4a0ad.js"><link rel="prefetch" href="/assets/js/32.dab0f919.js"><link rel="prefetch" href="/assets/js/33.ff4e525c.js"><link rel="prefetch" href="/assets/js/34.4972fdf0.js"><link rel="prefetch" href="/assets/js/35.8eef4f2e.js"><link rel="prefetch" href="/assets/js/36.12e3a40e.js"><link rel="prefetch" href="/assets/js/37.1d8cac74.js"><link rel="prefetch" href="/assets/js/38.1b9d84f3.js"><link rel="prefetch" href="/assets/js/39.8da043e8.js"><link rel="prefetch" href="/assets/js/4.f0bed083.js"><link rel="prefetch" href="/assets/js/40.cad56f3f.js"><link rel="prefetch" href="/assets/js/41.078ff48e.js"><link rel="prefetch" href="/assets/js/42.ccab846c.js"><link rel="prefetch" href="/assets/js/43.505c53c7.js"><link rel="prefetch" href="/assets/js/44.cd659556.js"><link rel="prefetch" href="/assets/js/45.14dd0e87.js"><link rel="prefetch" href="/assets/js/46.1839d303.js"><link rel="prefetch" href="/assets/js/47.b210acd4.js"><link rel="prefetch" href="/assets/js/48.5748de13.js"><link rel="prefetch" href="/assets/js/49.0855ea96.js"><link rel="prefetch" href="/assets/js/5.3325315f.js"><link rel="prefetch" href="/assets/js/50.ec32b7d5.js"><link rel="prefetch" href="/assets/js/51.2bbf040f.js"><link rel="prefetch" href="/assets/js/52.3305d4e2.js"><link rel="prefetch" href="/assets/js/53.5ddbb2ed.js"><link rel="prefetch" href="/assets/js/54.66fb0ed1.js"><link rel="prefetch" href="/assets/js/55.502aea49.js"><link rel="prefetch" href="/assets/js/56.b8d4f0b6.js"><link rel="prefetch" href="/assets/js/57.631c9b6f.js"><link rel="prefetch" href="/assets/js/58.de68c1bb.js"><link rel="prefetch" href="/assets/js/59.a8e3322d.js"><link rel="prefetch" href="/assets/js/6.e60bc4f1.js"><link rel="prefetch" href="/assets/js/60.405df580.js"><link rel="prefetch" href="/assets/js/61.b8c9ede6.js"><link rel="prefetch" href="/assets/js/62.ad006f4a.js"><link rel="prefetch" href="/assets/js/63.3a8cad4b.js"><link rel="prefetch" href="/assets/js/64.7f3316c4.js"><link rel="prefetch" href="/assets/js/65.baee1c39.js"><link rel="prefetch" href="/assets/js/66.726c4408.js"><link rel="prefetch" href="/assets/js/67.03b35a22.js"><link rel="prefetch" href="/assets/js/7.a139d7a8.js"><link rel="prefetch" href="/assets/js/8.bb4f29c6.js"><link rel="prefetch" href="/assets/js/9.7d18e657.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5d660632.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/avatar.jpeg" alt="童欧巴博客" class="logo"> <span class="site-name can-hide">童欧巴博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friends/" class="nav-link">友情链接</a></div> <a href="https://github.com/Geekhyt" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="http://hungryturbo.gitee.io/webcanteen/images/avatar.jpeg"> <div class="blogger-info"><h3>童欧巴</h3> <span>公众号【前端食堂】主理人</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friends/" class="nav-link">友情链接</a></div> <a href="https://github.com/Geekhyt" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/pages/4799d4/" aria-current="page" class="active sidebar-link">Node事件循环</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/4799d4/#事件循环" class="sidebar-link">事件循环</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/4799d4/#timers-定时器" class="sidebar-link">timers 定时器</a></li><li class="sidebar-sub-header"><a href="/pages/4799d4/#pending-callbacks-待定回调" class="sidebar-link">pending callbacks 待定回调</a></li><li class="sidebar-sub-header"><a href="/pages/4799d4/#idle，perpare" class="sidebar-link">idle，perpare</a></li><li class="sidebar-sub-header"><a href="/pages/4799d4/#poll-轮询" class="sidebar-link">poll 轮询</a></li><li class="sidebar-sub-header"><a href="/pages/4799d4/#check-检测" class="sidebar-link">check 检测</a></li><li class="sidebar-sub-header"><a href="/pages/4799d4/#close-callbacks-关闭的回调函数" class="sidebar-link">close callbacks 关闭的回调函数</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/4799d4/#libuv" class="sidebar-link">libuv</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/4799d4/#libuv主要解决的问题" class="sidebar-link">libuv主要解决的问题</a></li><li class="sidebar-sub-header"><a href="/pages/4799d4/#核心源码解读" class="sidebar-link">核心源码解读</a></li><li class="sidebar-sub-header"><a href="/pages/4799d4/#uv-io-start" class="sidebar-link">uv_iostart</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/4799d4/#node-js中的事件队列" class="sidebar-link">Node.js中的事件队列</a></li><li class="sidebar-sub-header"><a href="/pages/4799d4/#node-js与浏览器的event-loop差异" class="sidebar-link">Node.js与浏览器的Event Loop差异</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/4799d4/#node-js中的微任务" class="sidebar-link">Node.js中的微任务</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/4799d4/#node-js-v11变更的事件循环" class="sidebar-link">Node.js v11变更的事件循环</a></li></ul></li><li><a href="/pages/7f3ef1/" class="sidebar-link">Node异步编程进化论</a></li></ul> </aside> <div><main class="page"> <div class="theme-vdoing-wrapper bg-style-1"><div class="articleInfo-wrap" data-v-f5f35434><div class="articleInfo" data-v-f5f35434><ul class="breadcrumbs" data-v-f5f35434><li data-v-f5f35434><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-f5f35434></a></li> <li data-v-f5f35434><a href="/categories/?category=js" title="分类" data-v-f5f35434>js</a></li> <!----></ul> <div class="info" data-v-f5f35434><div title="作者" class="author iconfont icon-touxiang" data-v-f5f35434><a href="https://github.com/Geekhyt" target="_blank" title="作者" class="beLink" data-v-f5f35434>童欧巴</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-f5f35434><a href="javascript:;" data-v-f5f35434>2019-11-29</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><!---->
          Node.js事件循环
        </h1> <div class="theme-vdoing-content content__default"><p>从源码角度探求Node.js的事件循环本质。</p> <blockquote><p>本文已收录在<code>Github</code> <a href="https://github.com/Geekhyt/front-end-canteen" target="_blank" rel="noopener noreferrer">github.com/Geekhyt<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，感谢Star。</p></blockquote> <h2 id="事件循环"><a href="#事件循环" class="header-anchor">#</a> 事件循环</h2> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/node0.jpg" width="500"></p> <p>事件循环的执行顺序从图中可以看出，每次的事件循环都包含了上图中的6个阶段，接下来我们来一一解读它们。</p> <h3 id="timers-定时器"><a href="#timers-定时器" class="header-anchor">#</a> timers 定时器</h3> <p>计时器分为两类：</p> <ul><li>Immediate 在下一个check阶段执行</li> <li>Timeout 定时器过期后执行(delay参数默认值为1ms)</li></ul> <p>Timeout计时器又有两种类型：</p> <ul><li>Interval</li> <li>Timeout</li></ul> <p><code>这个阶段会执行setTimeout()和setInterval()设定的回调</code></p> <p><code>timers的执行是由poll阶段控制的</code></p> <p>setTimeout()和setInterval()和浏览器中的API是相同的。它们的实现原理与异步I/O比较类似，但是不需要I/O线程池的参与。</p> <p>这两个定时器创建后会被插入到定时器观察者内部的一个红黑树中。每次Tick执行时，都会从红黑树中取出定时器对象，来检查它们是否超过定时时间，超过便执行它们的回调。</p> <p>注意：定时器存在一个问题，就是它不是绝对精确的(在容忍范围内)。一旦某个事件循环中，有一个任务占用了较多的时间，那么再次轮到定时器执行时，时间就会受到影响。</p> <h4 id="无io处理情况"><a href="#无io处理情况" class="header-anchor">#</a> 无IO处理情况</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">timeout</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">immediate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>通过执行上面的代码我们可以发现，输出结果是不确定的。</p> <p>因为setTimeout（fn, 0)具有几毫秒的不确定性，无法保证进入timers阶段，定时器能立即执行处理程序。</p> <h4 id="有io处理情况"><a href="#有io处理情况" class="header-anchor">#</a> 有IO处理情况</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// immediate</span>
<span class="token comment">// timeout</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>此时setImmediate优先于setTimeout执行，因为poll阶段执行完成后进入check阶段，而timers阶段则处于下一个事件循环阶段了。</p> <h3 id="pending-callbacks-待定回调"><a href="#pending-callbacks-待定回调" class="header-anchor">#</a> pending callbacks 待定回调</h3> <p><code>执行大部分回调，除了close，times和setImmediate()设定的回调</code></p> <h3 id="idle，perpare"><a href="#idle，perpare" class="header-anchor">#</a> idle，perpare</h3> <p><code>仅供内部使用</code></p> <h3 id="poll-轮询"><a href="#poll-轮询" class="header-anchor">#</a> poll 轮询</h3> <p><code>获取新的I/O事件，在适当的条件下，Node.js会在这里阻塞</code></p> <p><code>这个阶段的主要任务是执行到达delay时间的timers定时器的回调，并且处理poll队列里的事件。</code></p> <p>当事件循环进入poll阶段，并且没有调用定时器时，将会发生以下两种情况：</p> <p>1.如果poll队列不为空，事件循环将遍历同步执行它们的回调队列。</p> <p>2.如果poll队列为空，又分为两种情况：</p> <ul><li><p>如果被setImmediate()回调调用，事件循环会结束poll阶段，进入到check阶段。</p></li> <li><p>如果没有被setImmediate()回调调用，事件循环将阻塞并等待回调添加到poll队列中执行。</p></li></ul> <p>一旦poll队列为空，事件循环将查看计时器是否到达delay时间，如果一个或多个定时器已达到delay时间，事件循环将回滚到timers定时器阶段，执行它们的回调。</p> <h3 id="check-检测"><a href="#check-检测" class="header-anchor">#</a> check 检测</h3> <p><code>setImmediate()设定的回调会在这一阶段执行</code></p> <p>如同上文poll阶段的第二种情况中，如果poll队列为空，并且被setImmediate()回调调用，事件循环将直接进入check阶段。</p> <h3 id="close-callbacks-关闭的回调函数"><a href="#close-callbacks-关闭的回调函数" class="header-anchor">#</a> close callbacks 关闭的回调函数</h3> <p><code>socket.on('close',callback)的回调会在这个阶段执行</code></p> <h2 id="libuv"><a href="#libuv" class="header-anchor">#</a> libuv</h2> <p><code>libuv为Node.js提供了整个事件循环功能。</code></p> <p align="center"><img src="https://cdn.jsdelivr.net/gh/Geekhyt/blogimgbed/blog/node1.png" width="500"></p> <p>如上图所示，在Windows下，事件循环基于<code>IOCP</code>创建，在linux下通过<code>epoll</code>实现，FreeBSD下通过<code>kqueue</code>实现，在Solaris下通过<code>Event ports</code>实现。</p> <p>我们再细心的去看上图，Network I/O和file I/O、DNS等实现方式是被分隔开的，这是因为他们的本质是由两套机制来实现的。我们一会儿来通过源码窥探它们的本质。</p> <p>实质上，当我们写JavaScript代码去调用Node的核心模块时，核心模块会调用C++内建模块，内建模块通过libuv进行系统调用。</p> <h3 id="libuv主要解决的问题"><a href="#libuv主要解决的问题" class="header-anchor">#</a> libuv主要解决的问题</h3> <p>在现实世界中，在所有不同类型的操作系统平台下，支持不同类型的I/O是非常困难的。那么为了支持跨平台I/O的同时，能更好的管理整个流程，抽象出了libuv。</p> <p>简单说，就是libuv抽象出一层API，可以帮助你调用各个平台和机器上各种系统特性，包括操作文件、监听socket等，而你不需要了解它们的具体实现。</p> <h3 id="核心源码解读"><a href="#核心源码解读" class="header-anchor">#</a> 核心源码解读</h3> <h4 id="核心函数uv-run"><a href="#核心函数uv-run" class="header-anchor">#</a> 核心函数uv_run</h4> <p><a href="https://github.com/libuv/libuv/blob/v1.x/src/unix/core.c" target="_blank" rel="noopener noreferrer">源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">uv_run</span><span class="token punctuation">(</span>uv_loop_t<span class="token operator">*</span> loop<span class="token punctuation">,</span> uv_run_mode mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> timeout<span class="token punctuation">;</span>
    <span class="token keyword">int</span> r<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ran_pending<span class="token punctuation">;</span>
    <span class="token comment">// 检查loop中是否有异步任务，没有就结束。</span>
    r <span class="token operator">=</span> <span class="token function">uv__loop_alive</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">)</span>
      <span class="token function">uv__update_time</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 事件循环while</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> loop<span class="token operator">-&gt;</span>stop_flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 更新事件阶段</span>
        <span class="token function">uv__update_time</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token comment">// 处理timer回调</span>
        <span class="token function">uv__run_timers</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token comment">// 处理异步任务回调</span>
        ran_pending <span class="token operator">=</span> <span class="token function">uv__run_pending</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>      
        <span class="token comment">// 供内部使用</span>
        <span class="token function">uv__run_idle</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">uv__run_prepare</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token comment">// uv_backend_timeout计算完毕后，会传给uv__io_poll</span>
        <span class="token comment">// 如果timeout = 0,则uv__io_poll会直接跳过</span>
        timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">==</span> UV_RUN_ONCE <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ran_pending <span class="token operator">||</span> mode <span class="token operator">==</span> UV_RUN_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">)</span>
          timeout <span class="token operator">=</span> <span class="token function">uv_backend_timeout</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">uv__io_poll</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// check阶段</span>
        <span class="token function">uv__run_check</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 关闭文件描述符等操作</span>
        <span class="token function">uv__run_closing_handles</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 检查loop中是否有异步任务，没有就结束。</span>
        r <span class="token operator">=</span> <span class="token function">uv__loop_alive</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> UV_RUN_ONCE <span class="token operator">||</span> mode <span class="token operator">==</span> UV_RUN_NOWAIT<span class="token punctuation">)</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>事件循环的真实面目是一个while。</p> <p>上文说到Network I/O与file I/O、DNS等是由两套机制来实现的。</p> <p>首先我们来看Network I/O，它最后的调用都会归结到<code>uv__io_start</code>这个函数，而该函数会将需要执行的I/O事件和回调放入watcher队列中，而<code>uv__io_poll</code>阶段会从watcher队列中取出事件调用系统的接口并执行。</p> <p>(<code>uv__io_poll</code>部分的代码过长大家感兴趣可自行查看)</p> <h3 id="uv-io-start"><a href="#uv-io-start" class="header-anchor">#</a> uv__io_start</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">uv__io_start</span><span class="token punctuation">(</span>uv_loop_t<span class="token operator">*</span> loop<span class="token punctuation">,</span> uv__io_t<span class="token operator">*</span> w<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token punctuation">(</span>events <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>POLLIN <span class="token operator">|</span> POLLOUT <span class="token operator">|</span> UV__POLLRDHUP <span class="token operator">|</span> UV__POLLPRI<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> events<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>w<span class="token operator">-&gt;</span>fd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>w<span class="token operator">-&gt;</span>fd <span class="token operator">&lt;</span> INT_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
  w<span class="token operator">-&gt;</span>pevents <span class="token operator">|=</span> events<span class="token punctuation">;</span>
  <span class="token function">maybe_resize</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> w<span class="token operator">-&gt;</span>fd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token operator">-&gt;</span>events <span class="token operator">==</span> w<span class="token operator">-&gt;</span>pevents<span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">QUEUE_EMPTY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>w<span class="token operator">-&gt;</span>watcher_queue<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">QUEUE_INSERT_TAIL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token operator">-&gt;</span>watcher_queue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>w<span class="token operator">-&gt;</span>watcher_queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>loop<span class="token operator">-&gt;</span>watchers<span class="token punctuation">[</span>w<span class="token operator">-&gt;</span>fd<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    loop<span class="token operator">-&gt;</span>watchers<span class="token punctuation">[</span>w<span class="token operator">-&gt;</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> w<span class="token punctuation">;</span>
    loop<span class="token operator">-&gt;</span>nfds<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>如上所示就是我们libuv中Network I/O这条主线实现过程。</p> <p>而另外一条主线是Fs I/O和DNS等操作则会调用<code>uv__work_sumit</code>这个函数，这个函数是执行线程池初始化<code>uv_queue_work</code>中最终调用的函数。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">uv__work_submit</span><span class="token punctuation">(</span>uv_loop_t<span class="token operator">*</span> loop<span class="token punctuation">,</span>
                     <span class="token keyword">struct</span> <span class="token class-name">uv__work</span><span class="token operator">*</span> w<span class="token punctuation">,</span>
                     <span class="token keyword">enum</span> <span class="token class-name">uv__work_kind</span> kind<span class="token punctuation">,</span>
                     <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>work<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">uv__work</span><span class="token operator">*</span> w<span class="token punctuation">)</span><span class="token punctuation">,</span>
                     <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>done<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">uv__work</span><span class="token operator">*</span> w<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">uv_once</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>once<span class="token punctuation">,</span> init_once<span class="token punctuation">)</span><span class="token punctuation">;</span>
  w<span class="token operator">-&gt;</span>loop <span class="token operator">=</span> loop<span class="token punctuation">;</span>
  w<span class="token operator">-&gt;</span>work <span class="token operator">=</span> work<span class="token punctuation">;</span>
  w<span class="token operator">-&gt;</span>done <span class="token operator">=</span> done<span class="token punctuation">;</span>
  <span class="token function">post</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>w<span class="token operator">-&gt;</span>wq<span class="token punctuation">,</span> kind<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">uv_queue_work</span><span class="token punctuation">(</span>uv_loop_t<span class="token operator">*</span> loop<span class="token punctuation">,</span>
                  uv_work_t<span class="token operator">*</span> req<span class="token punctuation">,</span>
                  uv_work_cb work_cb<span class="token punctuation">,</span>
                  uv_after_work_cb after_work_cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>work_cb <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> UV_EINVAL<span class="token punctuation">;</span>
  <span class="token function">uv__req_init</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> req<span class="token punctuation">,</span> UV_WORK<span class="token punctuation">)</span><span class="token punctuation">;</span>
  req<span class="token operator">-&gt;</span>loop <span class="token operator">=</span> loop<span class="token punctuation">;</span>
  req<span class="token operator">-&gt;</span>work_cb <span class="token operator">=</span> work_cb<span class="token punctuation">;</span>
  req<span class="token operator">-&gt;</span>after_work_cb <span class="token operator">=</span> after_work_cb<span class="token punctuation">;</span>
  <span class="token function">uv__work_submit</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span>
                  <span class="token operator">&amp;</span>req<span class="token operator">-&gt;</span>work_req<span class="token punctuation">,</span>
                  UV__WORK_CPU<span class="token punctuation">,</span>
                  uv__queue_work<span class="token punctuation">,</span>
                  uv__queue_done<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="node-js中的事件队列"><a href="#node-js中的事件队列" class="header-anchor">#</a> Node.js中的事件队列</h2> <p>Node.js中有多个队列，不同类型的事件在各自的队列中排队。在一个阶段结束后，进入下一个阶段之前，事件循环会在这中间处理中间队列。</p> <p>原生的libuv事件循环中的队列主要又4种类型：</p> <ul><li><p>过期的定时器和间隔队列</p></li> <li><p>IO事件队列</p></li> <li><p>Immediates队列</p></li> <li><p>close handlers队列</p></li></ul> <p>除此之外，Node.js还有两个中间队列</p> <ul><li><p>Next Ticks队列</p></li> <li><p>Other Microtasks队列</p></li></ul> <h2 id="node-js与浏览器的event-loop差异"><a href="#node-js与浏览器的event-loop差异" class="header-anchor">#</a> Node.js与浏览器的Event Loop差异</h2> <p>我们可以回顾下浏览器中JavaScript事件循环，请移步我的另一篇系列专栏<a href="/2019/07/javascript-evenloop/">浏览器中JavaScript的事件循环</a></p> <p>回来后，先说结论：</p> <p><strong>在浏览器中，microtask的任务队列是每个macrotask执行完之后执行。</strong></p> <p><strong>在Node.js中，microtask会在事件循环的各个阶段之间执行，也就是一个阶段执行完毕，就会去执行microtask队列的任务。</strong></p> <p>(本文的Macrotask在WHATWG 中叫task。Macrotask为了便于理解，并没有实际的出处。)</p> <p>相比于浏览器，node多出了<code>setImmediate(宏任务)</code>和<code>process.nextTick(微任务)</code>这两种异步操作。</p> <p><code>setImmediate</code>的回调函数被放在<code>check</code>阶段执行。而<code>process.nextTick</code>会被当做一种<code>microtask</code>，每个阶段结束后都会执行所有的<code>microtask</code>，你可以理解为<code>process.nextTick</code>可以<strong>插队</strong>，在下个阶段前执行。</p> <h4 id="process-nexttick插队带来的危害"><a href="#process-nexttick插队带来的危害" class="header-anchor">#</a> process.nextTick插队带来的危害</h4> <p>process.nextTick的回调会导致事件循环无法进入到下一个阶段。I/O处理完成或者定时器过期后仍然无法执行。会让其他的事件处理程序处于饥饿状态，为了防止这个问题，Node.js提供了一个<code>process.maxTickDepth</code>(默认为1000)。</p> <h3 id="node-js中的微任务"><a href="#node-js中的微任务" class="header-anchor">#</a> Node.js中的微任务</h3> <ul><li>process.nextTick()</li> <li>Promise.then()</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// nextTick</span>
<span class="token comment">// then</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>我们可以看到nextTick要早于then执行。</p> <h2 id="node-js-v11变更的事件循环"><a href="#node-js-v11变更的事件循环" class="header-anchor">#</a> Node.js v11变更的事件循环</h2> <p>从Node.js v11开始，事件循环的原理发生了变化，在同一个阶段中只要执行了macrotask就会立即执行microtask队列，与浏览器表现一致。具体请参考这个<a href="https://github.com/nodejs/node/pull/22842#discussion_r218142520" target="_blank" rel="noopener noreferrer">pr<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></div></div> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=Node.js" title="标签">#Node.js</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2020/10/01, 19:10:00</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><!----> <a href="/pages/7f3ef1/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Node异步编程进化论</div></a></div> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/pages/7f3ef1/">Node异步编程进化论</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/fa7f62/"><div>教女朋友学前端之深入理解JS引擎</div></a> <span>08-16</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/aa01e0/"><div>如何打造高效好用的终端？拿来吧你！</div></a> <span>07-14</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/c0e0d4/"><div>假如易立竞问你如何判断 JavaScript 中的数据类型？</div></a> <span>06-08</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div> </main></div> <div class="footer"><div class="icons"><a href="mailto:hungryturbo@gmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/Geekhyt" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://juejin.im/user/3491704662669469" title="掘金" target="_blank" class="iconfont icon-juejin"></a><a href="https://www.zhihu.com/people/huo-yi-tong-98" title="知乎" target="_blank" class="iconfont icon-zhihu"></a><a href="https://weibo.com/u/2771284557" title="微博" target="_blank" class="iconfont icon-weibo"></a><a href="https://space.bilibili.com/161753278" title="哔哩哔哩" target="_blank" class="iconfont icon-bilibili"></a></div> 
        © 2019-2021
        <span>童欧巴 | hungryturbo</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e6110941.js" defer></script><script src="/assets/js/2.d5df4bac.js" defer></script><script src="/assets/js/3.91f688ac.js" defer></script><script src="/assets/js/30.085db3bb.js" defer></script>
  </body>
</html>